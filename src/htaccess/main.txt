# -*- apache -*-
RewriteEngine On
RewriteBase /

# Old paths for post URLs and category indexes.  Also catch
# /2010/01/16/ntp-over-http%C2%A0Tambi%C3%A9n et al coming come from some
# Chinese site.
RewriteCond %{DOCUMENT_ROOT}/$1/$2 -d
RewriteRule ^(20[01][0-9])/[0-1][0-9]/[0-3][0-9]/([!-$&-.0-~]+)(?:/trackback)? \
            /$1/$2/             [END,R=permanent]

# Atom and RSS feeds.  Current code doesn’t have as much configuration as the
# old site so this flattens all of the feeds to a single format.  This very long
# prefix is because mod_negotiate comes before mod_rewrite so any requests to
# /atom/whatever end up being translated to /atom.xml/whatever or
# /atom.xml.gz/whatever.
RewriteCond %{DOCUMENT_ROOT}/c/$1 -d
RewriteRule ^atom(?:\.en|\.pl)?(?:\.xml)?(?:\.gz)?/cat/([a-z-]*)/.* \
            /c/$1/atom          [END,R=permanent]
RewriteRule ^atom(?:\.en|\.pl)?(?:\.xml)?(?:\.gz)?/ \
            /atom               [END,R=permanent]

# Icons
RewriteCond %{DOCUMENT_ROOT}/d/$1 -f
RewriteRule ^(?:apple-)?touch-icon-[0-9]+x([0-9]+(?:-precomposed)?\.png)$ \
            /d/$1               [END,R=permanent]
RewriteRule ^(?:apple-)?touch-icon.png(?:-precomposed)?$ \
            /d/192.png          [END,R=temp]

# If browser supports gzip and we have compressed file, send it.
Options +MultiViews
DirectoryIndex index

LanguagePriority en pl
ForceLanguagePriority Prefer Fallback
AddLanguage pl .pl

# Serve proper charset information
AddCharset UTF-8 .html .xml .js .css

# GPG key is ASCII-armored, i.e. it’s text/plain
AddType text/plain .pub

# application/javascript is technically correct but HTML5 uses text/javascript
# as SCRIPT’s default TYPE so let’s stick to that.
AddType text/javascript .js

# And lastly add proper type for atom files but don’t affect other XML files.
<FilesMatch "^atom.*[.]xml">
	AddType application/atom+xml .xml
</FilesMatch>

# Images almost never change so set a long expiry.  Everything else set expiry
# to one hour so changes are picked up quickly.  The /D/ directory has its own
# rules in its own .htaccess file.
ExpiresActive On
ExpiresDefault "access plus 1 hour"
ExpiresByType image/* "access plus 1 month"

Header set Strict-Transport-Security "max-age=31556925" \
       "expr=%{req_novary:X-Forwarded-Proto}=='https'"
